<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Financial Fact Find</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #ff6b35 0%, #1a1a1a 100%);
            color: white;
            margin-bottom: 30px;
            border-radius: 8px;
        }

        .logo-placeholder {
            width: 200px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border: 2px dashed rgba(255,255,255,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 12px;
        }

        .completion-tracker {
            text-align: right;
        }

        .completion-bar {
            width: 200px;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .completion-fill {
            height: 100%;
            background: #4CAF50;
            width: 25%;
            transition: width 0.3s ease;
        }

        /* Upload Section Styling */
        .upload-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px dashed #6c757d;
            margin-bottom: 30px;
            border-radius: 8px;
            padding: 20px;
        }

        .upload-box {
            border: 2px dashed #ff6b35;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 107, 53, 0.05);
            margin-bottom: 15px;
        }

        .upload-box:hover {
            background: rgba(255, 107, 53, 0.1);
            border-color: #e55a2b;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .uploaded-files {
            margin-top: 15px;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 5px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            color: white;
        }

        .status-uploaded { background: #6c757d; }
        .status-processing { background: #ffa500; }
        .status-processed { background: #4CAF50; }

        .ai-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .status-message {
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .section {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .section.hidden {
            display: none;
        }

        .section.required-missing {
            border-left: 4px solid #ff4444;
        }

        .section.optional-missing {
            border-left: 4px solid #ffa500;
        }

        .section.complete {
            border-left: 4px solid #4CAF50;
        }

        .section-header {
            background: #f5f5f5;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .section-header:hover {
            background: #eeeeee;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .priority-badge {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            color: white;
        }

        .priority-high { background: #ff4444; }
        .priority-medium { background: #ffa500; }
        .priority-low { background: #888; }

        .section-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .status-complete { background: #4CAF50; }
        .status-partial { background: #ffa500; }
        .status-missing { background: #ff4444; }

        .section-content {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        .ai-field {
            position: relative;
        }

        .ai-field::after {
            content: "🤖";
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            pointer-events: none;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.2);
        }

        .required-field {
            border-left: 3px solid #ff4444;
        }

        .ai-populated {
            background: #e8f5e8 !important;
            border-left: 3px solid #4CAF50;
        }

        .missing-data-alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .compliance-check {
            background: #e8f5e8;
            border: 1px solid #4CAF50;
            padding: 10px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 12px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #ff6b35;
            color: white;
        }

        .btn-primary:hover {
            background: #e55a2b;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .actions {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .expand-all {
            margin-bottom: 20px;
            text-align: right;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .completion-tracker {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-placeholder">
                Company Logo Here
            </div>
            <div>
                <h1>Smart Financial Fact Find</h1>
                <p>AI-Enhanced | FCA COBS Compliant | Consumer Duty Ready</p>
            </div>
            <div class="completion-tracker">
                <div>Completion: <span id="completion-percent">25%</span></div>
                <div class="completion-bar">
                    <div class="completion-fill" id="completion-fill"></div>
                </div>
                <small>Last updated: <span id="last-updated">Today</span></small>
            </div>
        </div>

        <!-- Document Upload Section -->
        <div class="upload-section">
            <h3>📁 Document Upload & AI Processing</h3>
            
            <!-- Hidden file input -->
            <input type="file" id="fileInput" accept=".txt,.docx,.pdf,.doc" multiple style="display: none;">
            
            <!-- Upload box that users click -->
            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">📄</div>
                <h4>Click to Upload Documents</h4>
                <p>Meeting transcripts, bank statements, payslips, policy documents</p>
                <small>Supports: .txt, .docx, .pdf files</small>
            </div>

            <!-- Show uploaded files -->
            <div id="fileList" class="uploaded-files"></div>

            <!-- Action buttons -->
            <div class="ai-actions">
                <button id="processBtn" class="btn btn-primary" onclick="processFiles()" disabled>
                    🤖 Extract Data with AI
                </button>
                <button class="btn btn-secondary" onclick="clearFiles()">
                    Clear All Files
                </button>
            </div>

            <!-- Status messages -->
            <div id="statusMessage"></div>

            <div class="compliance-check">
                ✅ Ready for AI document processing | Supports transcript analysis
            </div>
        </div>

        <div class="expand-all">
            <button class="btn btn-secondary" onclick="toggleAllSections()">Expand All Sections</button>
        </div>

        <!-- Meeting Information -->
        <div class="section complete">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title">
                    📅 Meeting Information
                    <span class="priority-badge priority-high">Required</span>
                </div>
                <div class="section-status">
                    <span class="status-indicator status-complete"></span>
                    <span>Complete</span>
                    <span>▼</span>
                </div>
            </div>
            <div class="section-content">
                <div class="form-row">
                    <div>
                        <label>Adviser Name</label>
                        <input type="text" class="ai-field" data-ai-field="adviser-name" placeholder="AI can extract from meeting notes">
                    </div>
                    <div>
                        <label>Date & Location</label>
                        <input type="text" class="ai-field" data-ai-field="meeting-date" placeholder="AI can extract from meeting notes">
                    </div>
                </div>
                <div class="form-row single">
                    <div>
                        <label>Attendees</label>
                        <input type="text" class="ai-field" placeholder="AI can extract from meeting notes">
                    </div>
                </div>
                <div class="compliance-check">
                    ✅ COBS 9.2 - Meeting documentation requirements satisfied
                </div>
            </div>
        </div>

        <!-- Financial Priorities -->
        <div class="section required-missing">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title">
                    🎯 Financial Priorities
                    <span class="priority-badge priority-high">Required</span>
                </div>
                <div class="section-status">
                    <span class="status-indicator status-missing"></span>
                    <span>Missing Data</span>
                    <span>▼</span>
                </div>
            </div>
            <div class="section-content">
                <div class="missing-data-alert">
                    ⚠️ Priority assessment required for Consumer Duty compliance - helps ensure suitable recommendations
                </div>
                
                <p><strong>Rate importance (1=Very Important, 5=Low Priority):</strong></p>
                
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Financial Need</th>
                                <th>Client 1</th>
                                <th>Client 2</th>
                                <th>AI Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Personal Protection</strong><br><small>Death, ill health, medical costs</small></td>
                                <td><select class="ai-field"><option>Select 1-5</option></select></td>
                                <td><select class="ai-field"><option>Select 1-5</option></select></td>
                                <td><input type="text" class="ai-field" placeholder="AI extracts reasoning"></td>
                            </tr>
                            <tr>
                                <td><strong>Pension Planning</strong><br><small>Saving for retirement</small></td>
                                <td><select class="ai-field"><option>Select 1-5</option></select></td>
                                <td><select class="ai-field"><option>Select 1-5</option></select></td>
                                <td><input type="text" class="ai-field" placeholder="AI extracts reasoning"></td>
                            </tr>
                            <tr>
                                <td><strong>Savings & Investments</strong><br><small>Regular and lump sum</small></td>
                                <td><select class="ai-field"><option>Select 1-5</option></select></td>
                                <td><select class="ai-field"><option>Select 1-5</option></select></td>
                                <td><input type="text" class="ai-field" placeholder="AI extracts reasoning"></td>
                            </tr>
                            <tr>
                                <td><strong>Estate Planning</strong><br><small>IHT planning and mitigation</small></td>
                                <td><select class="ai-field"><option>Select 1-5</option></select></td>
                                <td><select class="ai-field"><option>Select 1-5</option></select></td>
                                <td><input type="text" class="ai-field" placeholder="AI extracts reasoning"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="compliance-check">
                    ✅ COBS 9.2 - Client needs assessment | Consumer Duty - Understanding customer needs
                </div>
            </div>
        </div>

        <!-- Client Details -->
        <div class="section optional-missing">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title">
                    👥 Client Details
                    <span class="priority-badge priority-high">Required</span>
                </div>
                <div class="section-status">
                    <span class="status-indicator status-partial"></span>
                    <span>Partial</span>
                    <span>▼</span>
                </div>
            </div>
            <div class="section-content">
                <div class="form-row">
                    <div>
                        <h4>Client 1</h4>
                        <label>Full Name</label>
                        <input type="text" class="ai-field required-field" data-ai-field="client1-name" placeholder="AI extracts from documents">
                        
                        <label>Date of Birth</label>
                        <input type="date" class="ai-field required-field">
                        
                        <label>National Insurance Number</label>
                        <input type="text" class="ai-field" placeholder="AI extracts if provided">
                        
                        <label>Employment Status</label>
                        <select class="ai-field required-field" data-ai-field="client1-employment">
                            <option>Employed</option>
                            <option>Self-employed</option>
                            <option>Retired</option>
                            <option>Unemployed</option>
                        </select>
                    </div>
                    <div>
                        <h4>Client 2 (if applicable)</h4>
                        <label>Full Name</label>
                        <input type="text" class="ai-field" placeholder="AI extracts from documents">
                        
                        <label>Date of Birth</label>
                        <input type="date" class="ai-field">
                        
                        <label>National Insurance Number</label>
                        <input type="text" class="ai-field" placeholder="AI extracts if provided">
                        
                        <label>Employment Status</label>
                        <select class="ai-field">
                            <option>Select...</option>
                            <option>Employed</option>
                            <option>Self-employed</option>
                            <option>Retired</option>
                            <option>Unemployed</option>
                        </select>
                    </div>
                </div>
                
                <div class="compliance-check">
                    ✅ COBS 9.2 - Client identification and verification
                </div>
            </div>
        </div>

        <!-- Income & Expenditure -->
        <div class="section required-missing">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title">
                    💰 Income & Expenditure
                    <span class="priority-badge priority-high">Required</span>
                </div>
                <div class="section-status">
                    <span class="status-indicator status-missing"></span>
                    <span>Missing Data</span>
                    <span>▼</span>
                </div>
            </div>
            <div class="section-content">
                <div class="missing-data-alert">
                    ⚠️ Income and expenditure data required for affordability assessment (Consumer Duty)
                </div>
                
                <h4>Current Income (Annual)</h4>
                <div class="form-row">
                    <div>
                        <label>Client 1 - Gross Employment Income</label>
                        <input type="number" class="ai-field required-field" data-ai-field="client1-income" placeholder="£ - AI extracts from payslips">
                        
                        <label>Client 1 - Other Income</label>
                        <input type="number" class="ai-field" placeholder="£ - Investments, rental, etc.">
                    </div>
                    <div>
                        <label>Client 2 - Gross Employment Income</label>
                        <input type="number" class="ai-field" placeholder="£ - AI extracts from payslips">
                        
                        <label>Client 2 - Other Income</label>
                        <input type="number" class="ai-field" placeholder="£ - Investments, rental, etc.">
                    </div>
                </div>
                
                <h4>Essential Monthly Expenditure</h4>
                <div class="form-row">
                    <div>
                        <label>Housing Costs (Mortgage/Rent)</label>
                        <input type="number" class="ai-field required-field" data-ai-field="housing-costs" placeholder="£ - AI extracts from bank statements">
                        
                        <label>Household Bills</label>
                        <input type="number" class="ai-field" placeholder="£ - Utilities, council tax, etc.">
                    </div>
                    <div>
                        <label>Living Expenses</label>
                        <input type="number" class="ai-field" placeholder="£ - Food, transport, etc.">
                        
                        <label>Financial Commitments</label>
                        <input type="number" class="ai-field" placeholder="£ - Loans, credit cards, etc.">
                    </div>
                </div>
                
                <div class="form-row single">
                    <div>
                        <label>Available for Financial Planning (Monthly)</label>
                        <input type="number" class="ai-field required-field" placeholder="£ - Calculated automatically">
                    </div>
                </div>
                
                <div class="compliance-check">
                    ✅ Consumer Duty - Affordability assessment | COBS 9.2 - Financial situation
                </div>
            </div>
        </div>

        <!-- Assets & Liabilities -->
        <div class="section optional-missing">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title">
                    🏠 Assets & Liabilities
                    <span class="priority-badge priority-medium">Important</span>
                </div>
                <div class="section-status">
                    <span class="status-indicator status-partial"></span>
                    <span>Partial</span>
                    <span>▼</span>
                </div>
            </div>
            <div class="section-content">
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Asset Type</th>
                                <th>Current Value (£)</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Main Residence</td>
                                <td><input type="number" class="ai-field" placeholder="AI extracts from property docs"></td>
                                <td><input type="text" class="ai-field" placeholder="AI notes ownership, mortgage"></td>
                            </tr>
                            <tr>
                                <td>Cash Savings</td>
                                <td><input type="number" class="ai-field" placeholder="AI extracts from statements"></td>
                                <td><input type="text" class="ai-field" placeholder="Bank details, access"></td>
                            </tr>
                            <tr>
                                <td>Investments</td>
                                <td><input type="number" class="ai-field" placeholder="AI extracts from valuations"></td>
                                <td><input type="text" class="ai-field" placeholder="Types, providers"></td>
                            </tr>
                            <tr>
                                <td>Pension Funds</td>
                                <td><input type="number" class="ai-field" placeholder="AI extracts from statements"></td>
                                <td><input type="text" class="ai-field" placeholder="Providers, types"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="compliance-check">
                    ✅ COBS 9.2 - Financial situation assessment
                </div>
            </div>
        </div>

        <!-- Risk Assessment -->
        <div class="section required-missing">
            <div class="section-header" onclick="toggleSection(this)">
                <div class="section-title">
                    📊 Risk Assessment
                    <span class="priority-badge priority-high">Required</span>
                </div>
                <div class="section-status">
                    <span class="status-indicator status-missing"></span>
                    <span>Missing Data</span>
                    <span>▼</span>
                </div>
            </div>
            <div class="section-content">
                <div class="missing-data-alert">
                    ⚠️ Risk assessment required before any investment recommendations (COBS 9.2)
                </div>
                
                <div class="form-row">
                    <div>
                        <label>Risk Tolerance (Client 1)</label>
                        <select class="required-field">
                            <option>Select risk level...</option>
                            <option>Conservative</option>
                            <option>Cautious</option>
                            <option>Balanced</option>
                            <option>Adventurous</option>
                            <option>Aggressive</option>
                        </select>
                        
                        <label>Investment Experience</label>
                        <textarea class="ai-field" rows="3" placeholder="AI extracts experience from discussion"></textarea>
                    </div>
                    <div>
                        <label>Risk Tolerance (Client 2)</label>
                        <select>
                            <option>Select risk level...</option>
                            <option>Conservative</option>
                            <option>Cautious</option>
                            <option>Balanced</option>
                            <option>Adventurous</option>
                            <option>Aggressive</option>
                        </select>
                        
                        <label>Capacity for Loss</label>
                        <textarea class="ai-field" rows="3" placeholder="AI extracts capacity assessment"></textarea>
                    </div>
                </div>
                
                <div class="compliance-check">
                    ✅ COBS 9.2 - Appropriateness and suitability assessment
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="actions">
            <div>
                <button class="btn btn-secondary" onclick="saveProgress()">Save Progress</button>
                <button class="btn btn-secondary" onclick="uploadDocuments()">Upload Documents</button>
            </div>
            <div>
                <button class="btn btn-primary" onclick="generateReport()">Generate Fact Find Report</button>
                <button class="btn btn-primary" onclick="aiPopulate()">AI Auto-Populate</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        var sectionsExpanded = false;
        var fileList = [];

        function toggleSection(header) {
            var content = header.nextElementSibling;
            var arrow = header.querySelector('span:last-child');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.textContent = '▼';
            } else {
                content.style.display = 'none';
                arrow.textContent = '▶';
            }
        }

        function toggleAllSections() {
            var sections = document.querySelectorAll('.section-content');
            var button = event.target;
            
            sectionsExpanded = !sectionsExpanded;
            
            sections.forEach(function(section) {
                section.style.display = sectionsExpanded ? 'block' : 'none';
            });
            
            document.querySelectorAll('.section-header span:last-child').forEach(function(arrow) {
                arrow.textContent = sectionsExpanded ? '▼' : '▶';
            });
            
            button.textContent = sectionsExpanded ? 'Collapse All Sections' : 'Expand All Sections';
        }

        function updateCompletion() {
            var total = document.querySelectorAll('input, select, textarea').length;
            var completed = document.querySelectorAll('input[value]:not([value=""]), select:not([value=""]), textarea[value]:not([value=""])').length;
            var percentage = Math.round((completed / total) * 100);
            
            var percentElement = document.getElementById('completion-percent');
            var fillElement = document.getElementById('completion-fill');
            
            if (percentElement) percentElement.textContent = percentage + '%';
            if (fillElement) fillElement.style.width = percentage + '%';
        }

        function saveProgress() {
            alert('Progress saved successfully! Data stored locally for recovery.');
        }

        function uploadDocuments() {
            alert('Use the upload section at the top to upload documents for AI processing.');
        }

        function aiPopulate() {
            alert('Upload documents in the upload section and click "Extract Data with AI" to auto-populate fields.');
        }

        function generateReport() {
            // Collect all form data
            var reportData = collectFormData();
            
            if (reportData.completedFields < 10) {
                alert('Please complete more fields before generating a report. You need at least 10 completed fields.');
                return;
            }
            
            // Generate formatted HTML report
            var reportHTML = generateReportHTML(reportData);
            
            // Open report in new window
            var reportWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            
            // Also offer download option
            downloadReport(reportHTML, 'Financial_Fact_Find_Report.html');
        }

        function collectFormData() {
            var data = {
                // Meeting Information
                adviserName: getFieldValue('[data-ai-field="adviser-name"]'),
                meetingDate: getFieldValue('[data-ai-field="meeting-date"]'),
                attendees: getFieldValue('input[placeholder*="attendees"]'),
                
                // Client Details
                clientName: getFieldValue('[data-ai-field="client1-name"]'),
                clientDOB: getFieldValue('input[type="date"]'),
                clientNI: getFieldValue('input[placeholder*="Insurance"]'),
                employment: getFieldValue('[data-ai-field="client1-employment"]'),
                
                // Income & Expenditure
                income: getFieldValue('[data-ai-field="client1-income"]'),
                otherIncome: getFieldValue('input[placeholder*="Investments, rental"]'),
                housingCosts: getFieldValue('[data-ai-field="housing-costs"]'),
                householdBills: getFieldValue('input[placeholder*="Utilities"]'),
                livingExpenses: getFieldValue('input[placeholder*="Food, transport"]'),
                financialCommitments: getFieldValue('input[placeholder*="Loans, credit"]'),
                
                // Risk Assessment
                riskTolerance: getFieldValue('select option:checked'),
                investmentExperience: getFieldValue('textarea[placeholder*="experience"]'),
                capacityForLoss: getFieldValue('textarea[placeholder*="capacity"]'),
                
                // Count completed fields
                completedFields: 0,
                aiPopulatedFields: document.querySelectorAll('.ai-populated').length,
                totalFields: document.querySelectorAll('input, select, textarea').length
            };
            
            // Count completed fields
            Object.keys(data).forEach(function(key) {
                if (data[key] && data[key] !== '' && key !== 'completedFields' && key !== 'aiPopulatedFields' && key !== 'totalFields') {
                    data.completedFields++;
                }
            });
            
            return data;
        }

        function getFieldValue(selector) {
            var element = document.querySelector(selector);
            if (element) {
                return element.value || element.textContent || '';
            }
            return '';
        }

        function generateReportHTML(data) {
            var currentDate = new Date().toLocaleDateString();
            var completionPercentage = Math.round((data.completedFields / data.totalFields) * 100);
            
            return `
<!DOCTYPE html>
<html>
<head>
    <title>Financial Fact Find Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .header { background: linear-gradient(135deg, #ff6b35 0%, #1a1a1a 100%); color: white; padding: 20px; text-align: center; margin-bottom: 30px; }
        .section { margin-bottom: 25px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; }
        .section-header { background: #f5f5f5; padding: 10px 15px; font-weight: bold; border-bottom: 1px solid #ddd; }
        .section-content { padding: 15px; }
        .field-row { display: flex; margin-bottom: 10px; }
        .field-label { font-weight: bold; width: 200px; }
        .field-value { flex: 1; }
        .compliance-note { background: #e8f5e8; border: 1px solid #4CAF50; padding: 10px; margin: 10px 0; font-size: 12px; }
        .ai-populated { background: #e8f5e8; padding: 2px 5px; border-radius: 3px; }
        .summary-stats { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        @media print { body { margin: 20px; } .no-print { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>Financial Fact Find Report</h1>
        <p>AI-Enhanced | FCA COBS Compliant | Consumer Duty Ready</p>
        <p>Generated: ${currentDate}</p>
    </div>

    <div class="summary-stats">
        <h3>Report Summary</h3>
        <div class="field-row">
            <div class="field-label">Completion Status:</div>
            <div class="field-value">${completionPercentage}% Complete (${data.completedFields}/${data.totalFields} fields)</div>
        </div>
        <div class="field-row">
            <div class="field-label">AI Populated Fields:</div>
            <div class="field-value">${data.aiPopulatedFields} fields auto-populated</div>
        </div>
    </div>

    <div class="section">
        <div class="section-header">📅 Meeting Information</div>
        <div class="section-content">
            <div class="field-row">
                <div class="field-label">Adviser Name:</div>
                <div class="field-value ${data.adviserName ? 'ai-populated' : ''}">${data.adviserName || 'Not specified'}</div>
            </div>
            <div class="field-row">
                <div class="field-label">Meeting Date:</div>
                <div class="field-value ${data.meetingDate ? 'ai-populated' : ''}">${data.meetingDate || 'Not specified'}</div>
            </div>
            <div class="field-row">
                <div class="field-label">Attendees:</div>
                <div class="field-value">${data.attendees || 'Not specified'}</div>
            </div>
            <div class="compliance-note">✅ COBS 9.2 - Meeting documentation requirements satisfied</div>
        </div>
    </div>

    <div class="section">
        <div class="section-header">👥 Client Details</div>
        <div class="section-content">
            <div class="field-row">
                <div class="field-label">Client Name:</div>
                <div class="field-value ${data.clientName ? 'ai-populated' : ''}">${data.clientName || 'Not specified'}</div>
            </div>
            <div class="field-row">
                <div class="field-label">Date of Birth:</div>
                <div class="field-value">${data.clientDOB || 'Not specified'}</div>
            </div>
            <div class="field-row">
                <div class="field-label">National Insurance:</div>
                <div class="field-value">${data.clientNI || 'Not specified'}</div>
            </div>
            <div class="field-row">
                <div class="field-label">Employment Status:</div>
                <div class="field-value ${data.employment ? 'ai-populated' : ''}">${data.employment || 'Not specified'}</div>
            </div>
            <div class="compliance-note">✅ COBS 9.2 - Client identification and verification</div>
        </div>
    </div>

    <div class="section">
        <div class="section-header">💰 Income & Expenditure</div>
        <div class="section-content">
            <div class="field-row">
                <div class="field-label">Annual Income:</div>
                <div class="field-value ${data.income ? 'ai-populated' : ''}">£${data.income || 'Not specified'}</div>
            </div>
            <div class="field-row">
                <div class="field-label">Other Income:</div>
                <div class="field-value">£${data.otherIncome || 'Not specified'}</div>
            </div>
            <div class="field-row">
                <div class="field-label">Housing Costs:</div>
                <div class="field-value ${data.housingCosts ? 'ai-populated' : ''}">£${data.housingCosts || 'Not specified'}/month</div>
            </div>
            <div class="field-row">
                <div class="field-label">Household Bills:</div>
                <div class="field-value">£${data.householdBills || 'Not specified'}/month</div>
            </div>
            <div class="field-row">
                <div class="field-label">Living Expenses:</div>
                <div class="field-value">£${data.livingExpenses || 'Not specified'}/month</div>
            </div>
            <div class="field-row">
                <div class="field-label">Financial Commitments:</div>
                <div class="field-value">£${data.financialCommitments || 'Not specified'}/month</div>
            </div>
            <div class="compliance-note">✅ Consumer Duty - Affordability assessment | COBS 9.2 - Financial situation</div>
        </div>
    </div>

    <div class="section">
        <div class="section-header">📊 Risk Assessment</div>
        <div class="section-content">
            <div class="field-row">
                <div class="field-label">Risk Tolerance:</div>
                <div class="field-value">${data.riskTolerance || 'Not assessed'}</div>
            </div>
            <div class="field-row">
                <div class="field-label">Investment Experience:</div>
                <div class="field-value ${data.investmentExperience ? 'ai-populated' : ''}">${data.investmentExperience || 'Not specified'}</div>
            </div>
            <div class="field-row">
                <div class="field-label">Capacity for Loss:</div>
                <div class="field-value ${data.capacityForLoss ? 'ai-populated' : ''}">${data.capacityForLoss || 'Not specified'}</div>
            </div>
            <div class="compliance-note">✅ COBS 9.2 - Appropriateness and suitability assessment</div>
        </div>
    </div>

    <div class="section no-print">
        <div class="section-header">📋 Report Actions</div>
        <div class="section-content">
            <button onclick="window.print()" style="padding: 10px 20px; margin-right: 10px; background: #ff6b35; color: white; border: none; border-radius: 4px; cursor: pointer;">Print Report</button>
            <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Close Window</button>
        </div>
    </div>

    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
        <p>This report was generated automatically from the Smart Financial Fact Find system.</p>
        <p>Green highlighted fields were populated by AI from uploaded documents.</p>
    </div>
</body>
</html>`;
        }

        function downloadReport(htmlContent, filename) {
            var blob = new Blob([htmlContent], { type: 'text/html' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showStatus('✅ Report generated and downloaded! Check your Downloads folder.', 'success');
        }

        // File upload functions
        function showStatus(message, type) {
            var statusDiv = document.getElementById('statusMessage');
            if (statusDiv) {
                statusDiv.innerHTML = '<div class="status-message status-' + type + '">' + message + '</div>';
                
                setTimeout(function() {
                    if (statusDiv) {
                        statusDiv.innerHTML = '';
                    }
                }, 8000);
            }
        }

        function displayFiles() {
            var fileListDiv = document.getElementById('fileList');
            if (!fileListDiv) return;
            
            if (fileList.length === 0) {
                fileListDiv.innerHTML = '';
                return;
            }

            var html = '';
            for (var i = 0; i < fileList.length; i++) {
                var file = fileList[i];
                html += '<div class="file-item">' +
                       '<div class="file-info">' +
                       '<span>📄</span>' +
                       '<span><strong>' + file.name + '</strong></span>' +
                       '<span class="file-status status-' + file.status + '">' + file.status.toUpperCase() + '</span>' +
                       '</div>' +
                       '<button onclick="removeFile(' + i + ')" class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;">Remove</button>' +
                       '</div>';
            }
            fileListDiv.innerHTML = html;
        }

        function removeFile(index) {
            fileList.splice(index, 1);
            displayFiles();
            updateProcessButton();
            showStatus('File removed.', 'info');
        }

        function clearFiles() {
            fileList = [];
            var fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.value = '';
            }
            displayFiles();
            updateProcessButton();
            showStatus('All files cleared.', 'info');
        }

        function updateProcessButton() {
            var btn = document.getElementById('processBtn');
            if (btn) {
                btn.disabled = fileList.length === 0;
            }
        }

        function readTextFile(file) {
            return new Promise(function(resolve, reject) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }

        function extractPattern(text, patterns) {
            if (!Array.isArray(patterns)) patterns = [patterns];
            
            for (var i = 0; i < patterns.length; i++) {
                var match = text.match(patterns[i]);
                if (match) return match[1];
            }
            return '';
        }

        function extractFinancialPriorities(text) {
            var patterns = [
                /(?:priority|priorities|goal|goals|objective|important|worry|worried|concern|concerned)\s+(?:is|are|about)?\s*([^.!?]{20,150})/gi,
                /(?:want|need|like|hope)\s+to\s+([^.!?]{20,100})/gi,
                /(?:planning|saving|investing)\s+for\s+([^.!?]{20,100})/gi,
                /(?:pay off|clear|debt|debts)\s+([^.!?]{10,80})/gi
            ];
            
            var priorities = [];
            patterns.forEach(function(pattern) {
                var matches = text.match(pattern);
                if (matches) {
                    for (var i = 0; i < matches.length; i++) {
                        if (matches[i] && matches[i].trim().length > 10) {
                            priorities.push(matches[i].trim());
                        }
                    }
                }
            });
            
            return priorities.slice(0, 5).join('; ');
        }

        function populateFormFields(data) {
            var fieldMappings = [
                // Meeting Information
                { selector: '[data-ai-field="adviser-name"]', value: data.adviserName },
                { selector: '[data-ai-field="meeting-date"]', value: data.meetingDate },
                
                // Client Details
                { selector: '[data-ai-field="client1-name"]', value: data.clientName },
                { selector: '[data-ai-field="client1-employment"]', value: data.employment },
                
                // Income & Expenditure
                { selector: '[data-ai-field="client1-income"]', value: data.income },
                { selector: '[data-ai-field="housing-costs"]', value: data.housingCosts },
                
                // Financial Priorities - populate AI Notes columns
                { selector: 'table tbody tr:nth-child(1) td:nth-child(4) input', value: data.priorities },
                { selector: 'table tbody tr:nth-child(2) td:nth-child(4) input', value: data.priorities },
                { selector: 'table tbody tr:nth-child(3) td:nth-child(4) input', value: data.priorities },
                { selector: 'table tbody tr:nth-child(4) td:nth-child(4) input', value: data.priorities }
            ];

            var extractedCount = 0;
            fieldMappings.forEach(function(mapping) {
                var element = document.querySelector(mapping.selector);
                
                if (element && mapping.value) {
                    element.value = mapping.value;
                    element.classList.add('ai-populated');
                    extractedCount++;
                }
            });
            
            // Also populate any textareas with summary
            var textareas = document.querySelectorAll('textarea.ai-field');
            textareas.forEach(function(textarea) {
                if (data.priorities && !textarea.value) {
                    textarea.value = data.priorities;
                    textarea.classList.add('ai-populated');
                    extractedCount++;
                }
            });
            
            // Create comprehensive notes summary
            var summaryNotes = generateNoteSummary(data);
            var notesFields = document.querySelectorAll('textarea:not(.ai-field)');
            if (notesFields.length > 0 && summaryNotes) {
                notesFields[0].value = summaryNotes;
                notesFields[0].classList.add('ai-populated');
            }
            
            updateCompletion();
            showStatus('✅ Extracted and populated ' + extractedCount + ' fields across multiple sections', 'success');
            console.log('Extracted ' + extractedCount + ' pieces of information:', data);
        }

        function generateNoteSummary(data) {
            var notes = 'AI EXTRACTION SUMMARY:\n\n';
            if (data.clientName) notes += '• Client: ' + data.clientName + '\n';
            if (data.adviserName) notes += '• Adviser: ' + data.adviserName + '\n';
            if (data.meetingDate) notes += '• Meeting Date: ' + data.meetingDate + '\n';
            if (data.income) notes += '• Annual Income: £' + data.income + '\n';
            if (data.employment) notes += '• Employment: ' + data.employment + '\n';
            if (data.housingCosts) notes += '• Housing Costs: £' + data.housingCosts + '/month\n';
            if (data.priorities) notes += '• Financial Priorities: ' + data.priorities + '\n';
            
            notes += '\nProcessed from ' + fileList.length + ' document(s)';
            return notes;
        }

        async function processFiles() {
            if (fileList.length === 0) {
                showStatus('Please upload some files first.', 'error');
                return;
            }

            var processBtn = document.getElementById('processBtn');
            if (!processBtn) return;
            
            processBtn.disabled = true;
            processBtn.textContent = '🤖 Processing...';

            fileList.forEach(function(fileObj) {
                fileObj.status = 'processing';
            });
            displayFiles();

            showStatus('AI is analyzing your documents and extracting financial data...', 'info');

            try {
                var allText = '';
                for (var i = 0; i < fileList.length; i++) {
                    var file = fileList[i];
                    if (file.file.type === 'text/plain') {
                        var text = await readTextFile(file.file);
                        allText += ' ' + text;
                    }
                }

                // Simulate processing delay
                await new Promise(function(resolve) {
                    setTimeout(resolve, 3000);
                });

                <!-- Enhanced extraction with more data points -->
                var extractedData = {
                    adviserName: extractPattern(allText, [
                        /([a-z]+\s+[a-z]+)\s+(?:started transcription|is the adviser)/i,
                        /meeting with\s+([a-z]+\s+[a-z]+)/i
                    ]),
                    clientName: extractPattern(allText, [
                        /(?:client|meet(?:ing)?\s+with|hello)\s+([a-z]+\s+[a-z]+)/i,
                        /([a-z]+\s+[a-z]+)(?:\s+(?:said|mentioned|told))/i
                    ]),
                    income: extractPattern(allText, [
                        /(?:salary|income|earn|make|paid)\s+(?:is|around|about|up)?\s*[£$]?([0-9,]+)/i,
                        /money\s+(?:has\s+)?(?:gone\s+)?up.*?([0-9,]+)/i,
                        /it\'s\s+([0-9,]+)/i
                    ]),
                    employment: extractPattern(allText, [
                        /(employed|self-employed|retired|unemployed)/i,
                        /i'm\s+an?\s+([^,\.]+)(?:coordinator|manager|director)/i,
                        /(?:work|working)\s+(?:at|for|in)/i
                    ]),
                    housingCosts: extractPattern(allText, [
                        /(?:mortgage|rent|housing)\s+(?:is|costs|payment)?\s*[£$]?([0-9,]+)/i,
                        /(?:pay|paying)\s+(?:about|around)?\s*[£$]?([0-9,]+)\s+(?:for|on)?\s*(?:mortgage|rent|house)/i
                    ]),
                    meetingDate: extractPattern(allText, [
                        /(\d{1,2}(?:st|nd|rd|th)?\s+(?:january|february|march|april|may|june|july|august|september|october|november|december)\s+\d{4})/i,
                        /(\d{1,2}\/\d{1,2}\/\d{4})/
                    ]),
                    priorities: extractFinancialPriorities(allText),
                    
                    // Additional extraction
                    debtAmount: extractPattern(allText, [
                        /debt.*?[£$]?([0-9,]+)/i,
                        /(?:owe|loan|credit).*?[£$]?([0-9,]+)/i
                    ]),
                    propertyValue: extractPattern(allText, [
                        /(?:property|house|flat).*?[£$]?([0-9,]+)/i,
                        /offer.*?accepted.*?([0-9,]+)/i
                    ])
                };

                populateFormFields(extractedData);

                fileList.forEach(function(fileObj) {
                    fileObj.status = 'processed';
                });
                displayFiles();
                
                showStatus('✅ AI processing complete! Data has been extracted to the form fields. Fields highlighted in green were populated by AI.', 'success');
                
            } catch (error) {
                console.error('Processing error:', error);
                showStatus('❌ Processing failed. Please try again.', 'error');
                
                fileList.forEach(function(fileObj) {
                    fileObj.status = 'uploaded';
                });
                displayFiles();
            } finally {
                if (processBtn) {
                    processBtn.disabled = false;
                    processBtn.textContent = '🤖 Extract Data with AI';
                }
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Collapse all sections initially
            document.querySelectorAll('.section-content').forEach(function(section) {
                section.style.display = 'none';
            });
            
            document.querySelectorAll('.section-header span:last-child').forEach(function(arrow) {
                arrow.textContent = '▶';
            });
            
            // Update timestamp
            var lastUpdatedElement = document.getElementById('last-updated');
            if (lastUpdatedElement) {
                lastUpdatedElement.textContent = new Date().toLocaleDateString();
            }
            
            // Add event listeners for completion tracking
            document.querySelectorAll('input, select, textarea').forEach(function(element) {
                element.addEventListener('change', updateCompletion);
                element.addEventListener('input', updateCompletion);
            });

            // Initialize file upload
            var fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    var files = Array.from(e.target.files);
                    
                    files.forEach(function(file) {
                        if (!fileList.find(function(f) { return f.name === file.name && f.size === file.size; })) {
                            fileList.push({
                                file: file,
                                name: file.name,
                                size: file.size,
                                status: 'uploaded'
                            });
                        }
                    });
                    
                    displayFiles();
                    updateProcessButton();
                    showStatus('Files uploaded successfully. Click "Extract Data with AI" to process.', 'success');
                });
            }

            updateProcessButton();
            showStatus('Upload documents and click "Extract Data with AI" to auto-populate the fact find.', 'info');
        });
    </script>
</body>
</html>